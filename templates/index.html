<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Generalization by Simplification</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- MapLibre -->
    <link
      href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        background: #f5f7fa;
      }

      #map {
        height: calc(100vh - 100px);
        width: 100%;
      }

      .settings-box {
        background: #ffffff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      input[type="number"] {
        width: 100%;
      }
    </style>
  </head>

  <body>
    <!-- Title -->
    <div class="container-fluid py-3 bg-white shadow-sm">
      <h1 class="text-center fw-bold">GeoJSON Simplifier & Map Viewer</h1>
    </div>

    <!-- Main layout -->
    <div class="container-fluid mt-3">
      <div class="row">
        <!-- Left column: settings -->
        <div class="col-md-3">
          <div class="settings-box">
            <h4 class="form-label">Upload GeoJSON</h4>
            <!-- Custom English File Input -->
            <div class="mb-3">
              <div class="input-group">
                <button class="btn btn-secondary" id="customFileBtn">
                  Choose File
                </button>
                <input
                  type="file"
                  id="fileInput"
                  accept=".geojson,.json"
                  class="d-none"
                />
                <input
                  type="text"
                  id="fileNameDisplay"
                  class="form-control"
                  placeholder="No file chosen"
                  readonly
                />
              </div>
            </div>

            <h4 class="form-label">Tolerance</h4>
            <input
              id="tolerance"
              type="number"
              step="0.1"
              value="1"
              class="form-control mb-3"
            />

            <button class="btn btn-primary w-100 mb-3" onclick="simplify()">
              Simplify
            </button>

            <h4>Layers</h4>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="toggleOriginal"
                checked
              />
              <label class="form-check-label">Show Original</label>
            </div>

            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="toggleSimplified"
                checked
              />
              <label class="form-check-label">Show Simplified</label>
            </div>
          </div>
        </div>

        <!-- Right column: map -->
        <div class="col-md-9">
          <div id="map"></div>
        </div>
      </div>
    </div>

    <script>
      /* Map init */
      let map = new maplibregl.Map({
        container: "map",
        style: "https://demotiles.maplibre.org/style.json",
        center: [114.1, 22.43],
        zoom: 16,
      });

      let originalGeoJSON = null;
      let simplifiedGeoJSON = null;

      /* Custom file input (forces English) */
      document.getElementById("customFileBtn").addEventListener("click", () => {
        document.getElementById("fileInput").click();
      });

      document.getElementById("fileInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        document.getElementById("fileNameDisplay").value = file
          ? file.name
          : "No file chosen";
      });

      /* Clear map immediately when clicking file input */
      document.getElementById("fileInput").addEventListener("click", () => {
        if (map.getLayer("original")) map.removeLayer("original");
        if (map.getSource("original")) map.removeSource("original");

        if (map.getLayer("simplified")) map.removeLayer("simplified");
        if (map.getSource("simplified")) map.removeSource("simplified");

        document.getElementById("toggleOriginal").checked = true;
        document.getElementById("toggleSimplified").checked = true;

        originalGeoJSON = null;
        simplifiedGeoJSON = null;
      });

      /* Load GeoJSON */
      document
        .getElementById("fileInput")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (event) {
            let data = JSON.parse(event.target.result);

            if (data.type === "Feature") {
              data = {
                type: "FeatureCollection",
                features: [data],
              };
            }

            originalGeoJSON = data;

            showOriginal(originalGeoJSON);
            fitToBounds(originalGeoJSON);
          };
          reader.readAsText(file);
        });

      /* Add original layer */
      function showOriginal(data) {
        if (map.getSource("original")) {
          map.getSource("original").setData(data);
        } else {
          map.addSource("original", { type: "geojson", data });
          map.addLayer({
            id: "original",
            type: "fill",
            source: "original",
            paint: { "fill-color": "#ff0000", "fill-opacity": 0.5 },
          });
        }
      }

      /* Add simplified layer */
      function showSimplified(data) {
        if (map.getSource("simplified")) {
          map.getSource("simplified").setData(data);
        } else {
          map.addSource("simplified", { type: "geojson", data });
          map.addLayer({
            id: "simplified",
            type: "fill",
            source: "simplified",
            paint: { "fill-color": "#00aa00", "fill-opacity": 0.5 },
          });
        }
      }

      /* Fit bounds */
      function fitToBounds(geojson) {
        const bounds = new maplibregl.LngLatBounds();

        geojson.features.forEach((f) => {
          const geom = f.geometry;

          if (geom.type === "Polygon") {
            geom.coordinates.forEach((ring) => {
              ring.forEach((coord) => bounds.extend(coord));
            });
          }

          if (geom.type === "MultiPolygon") {
            geom.coordinates.forEach((poly) => {
              poly.forEach((ring) => {
                ring.forEach((coord) => bounds.extend(coord));
              });
            });
          }
        });

        if (!bounds.isEmpty()) {
          map.fitBounds(bounds, { padding: 40 });
        }
      }

      /* Simplify */
      async function simplify() {
        const tolerance = parseFloat(
          document.getElementById("tolerance").value,
        );

        const response = await fetch("/simplify", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ...originalGeoJSON, tolerance }),
        });

        simplifiedGeoJSON = await response.json();
        showSimplified(simplifiedGeoJSON);
        fitToBounds(simplifiedGeoJSON);
      }

      /* Layer Toggles */
      document.getElementById("toggleOriginal").onchange = function () {
        map.setLayoutProperty(
          "original",
          "visibility",
          this.checked ? "visible" : "none",
        );
      };

      document.getElementById("toggleSimplified").onchange = function () {
        map.setLayoutProperty(
          "simplified",
          "visibility",
          this.checked ? "visible" : "none",
        );
      };
    </script>
  </body>
</html>
